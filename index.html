<!-- --- DEBUG OVERLAY: вставьте в index.html --- -->
<style>
  #tg-debug {
    position: fixed; right: 12px; bottom: 12px; z-index: 9999;
    background: rgba(0,0,0,0.85); color: #fff; padding: 10px 12px; border-radius: 8px;
    font-family: Arial, sans-serif; font-size:13px; width:320px; box-shadow:0 6px 20px rgba(0,0,0,0.3);
  }
  #tg-debug button{ margin-top:8px; width:100%; padding:8px; border-radius:6px; border:none; cursor:pointer; }
  #tg-debug .ok{ color:#8be78b; font-weight:700; }
  #tg-debug .bad{ color:#ff8b8b; font-weight:700; }
  #tg-debug small{ color:#ddd; display:block; margin-top:6px; font-size:11px; }
</style>

<div id="tg-debug" role="region" aria-label="Telegram WebApp debug">
  <div>Telegram.WebApp: <span id="tg-status">проверка...</span></div>
  <div style="margin-top:6px;">initData type: <span id="tg-init">—</span></div>
  <button id="tg-send" style="background:#2a9d8f;color:#fff;">Отправить тест через Telegram.WebApp.sendData()</button>
  <button id="tg-fallback" style="background:#6c757d;color:#fff;">Fallback → отправить прямо в n8n (для отладки)</button>
  <small id="tg-log">Логи: —</small>
</div>

<script>
  const statusEl = document.getElementById('tg-status');
  const initEl = document.getElementById('tg-init');
  const logEl = document.getElementById('tg-log');
  const sendBtn = document.getElementById('tg-send');
  const fallbackBtn = document.getElementById('tg-fallback');

  function log(msg){
    console.log('[tg-debug]', msg);
    logEl.textContent = 'Логи: ' + msg;
  }

  function updateStatus(){
    const hasTg = (typeof window.Telegram === 'object' && typeof Telegram.WebApp === 'object');
    if(hasTg){
      statusEl.innerHTML = '<span class="ok">доступен</span>';
      initEl.textContent = (typeof Telegram.WebApp.initData === 'string') ? 'string' : String(typeof Telegram.WebApp.initData);
      log('Telegram.WebApp присутствует. initDataUnsafe: ' + JSON.stringify(Telegram.WebApp.initDataUnsafe || {}));
    } else {
      statusEl.innerHTML = '<span class="bad">отсутствует</span>';
      initEl.textContent = 'n/a';
      log('Telegram.WebApp не найден. Страница, вероятно, открыта не через Web App.');
    }
  }

  updateStatus();

  // пробуем обновлять раз в секунду первые 5 секунд (иногда объект инициализируется чуть позже)
  let tries = 0;
  const interval = setInterval(()=>{
    tries++;
    updateStatus();
    if(tries>5) clearInterval(interval);
  }, 1000);

  sendBtn.addEventListener('click', async ()=>{
    if(typeof window.Telegram === 'object' && typeof Telegram.WebApp === 'object'){
      const payload = { debugPing: true, ts: new Date().toISOString() };
      try{
        Telegram.WebApp.sendData(JSON.stringify(payload));
        log('Вызван Telegram.WebApp.sendData() с payload: ' + JSON.stringify(payload));
        alert('Вызван sendData(). Проверьте, пришло ли update на ваш webhook в n8n (message.web_app_data.data).');
      }catch(e){
        log('Ошибка sendData: ' + e.message);
        alert('Ошибка sendData: ' + e.message);
      }
    } else {
      alert('Telegram.WebApp недоступен — откройте приложение через кнопку в боте (не по прямой ссылке).');
    }
  });

  fallbackBtn.addEventListener('click', async ()=>{
    // --- РАСКОММЕНТИРУЙТЕ / ЗАПОЛНИТЕ для отладки ---
    const N8N_WEBHOOK = 'https://florencia-tachistoscopic-snidely.ngrok-free.dev/webhook-test/f43c5c03-ca03-4394-b3f4-6562f5d9d65a/webhook'; // <-- вставьте сюда ваш тестовый webhook n8n, например: https://your-n8n.example.com/webhook/test
    if(!N8N_WEBHOOK){
      alert('Fallback отключён: вставьте URL вашего n8n webhook в переменную N8N_WEBHOOK в коде.');
      return;
    }
    const payload = { debugFallback: true, ts: new Date().toISOString(), userHint: Telegram?.WebApp?.initDataUnsafe || null };
    try{
      const res = await fetch(N8N_WEBHOOK, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Debug': 'true' },
        body: JSON.stringify(payload)
      });
      const txt = await res.text();
      log('Fallback отправлен, ответ n8n: ' + txt.slice(0,200));
      alert('Fallback отправлен. Ответ: ' + txt.slice(0,200));
    }catch(e){
      log('Fallback failed: ' + e.message);
      alert('Ошибка отправки в n8n: ' + e.message);
    }
  });
</script>
