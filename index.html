<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Telegram Mini App</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0; }
    .container { background:#fff; padding:20px 30px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1); width:100%; max-width:600px; }
    h2 { text-align:center; margin-bottom:18px; color:#333; }
    .test-section { margin-bottom:20px; padding:15px; border:1px solid #ddd; border-radius:8px; }
    .test-section h3 { margin:0 0 10px 0; font-size:16px; }
    .result { padding:8px; margin:8px 0; border-radius:4px; }
    .success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
    .warning { background:#fff3cd; color:#856404; border:1px solid #ffeeba; }
    .info { background:#d1ecf1; color:#0c5460; border:1px solid #bee5eb; }
    pre { background:#f8f9fa; padding:10px; border-radius:4px; overflow-x:auto; font-size:12px; }
    button { padding:8px 15px; margin:5px 0; border:none; border-radius:4px; cursor:pointer; }
    .btn-test { background:#007bff; color:white; }
    .btn-clear { background:#6c757d; color:white; }
    .clear-btn { background:#dc3545; color:white; }
  </style>
</head>
<body>

<div class="container">
  <h2>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Telegram Mini App</h2>

  <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: Telegram WebApp API -->
  <div class="test-section">
    <h3>1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram WebApp API</h3>
    <div id="api-test"></div>
    <button class="btn-test" onclick="checkTelegramAPI()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å API</button>
  </div>

  <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: initData -->
  <div class="test-section">
    <h3>2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ initData</h3>
    <div id="initdata-test"></div>
    <button class="btn-test" onclick="checkInitData()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å initData</button>
    <button class="btn-clear" onclick="clearInitData()">–û—á–∏—Å—Ç–∏—Ç—å initData (—Å–∏–º—É–ª—è—Ü–∏—è –ø—Ä—è–º–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è)</button>
  </div>

  <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: User data -->
  <div class="test-section">
    <h3>3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
    <div id="user-test"></div>
    <button class="btn-test" onclick="checkUserData()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
  </div>

  <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö -->
  <div class="test-section">
    <h3>4Ô∏è‚É£ –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h3>
    <div id="send-test"></div>
    <button class="btn-test" onclick="testSendData()">–¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ sendData</button>
    <button class="btn-test" onclick="testSendToWebhook()">–¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ webhook</button>
  </div>

  <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
  <div class="test-section">
    <h3>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ</h3>
    <div class="info">
      <strong>–î–ª—è –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:</strong><br>
      1. –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞ –≤ Telegram<br>
      2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø–æ –ø–æ—Ä—è–¥–∫—É<br>
      3. –°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤<br>
      4. –°—Ä–∞–≤–Ω–∏—Ç–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø—Ä–∏ –ø—Ä—è–º–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    </div>
  </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
function showResult(containerId, message, type = 'info') {
  const container = document.getElementById(containerId);
  const div = document.createElement('div');
  div.className = `result ${type}`;
  div.innerHTML = message;
  container.appendChild(div);
}

// –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
function clearContainer(containerId) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
}

// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram API
function checkTelegramAPI() {
  clearContainer('api-test');
  
  let result = '';
  let type = 'error';
  
  if (window.Telegram && Telegram.WebApp) {
    result += '<strong>‚úÖ Telegram.WebApp –¥–æ—Å—Ç—É–ø–µ–Ω</strong><br>';
    result += `–í–µ—Ä—Å–∏—è: ${Telegram.WebApp.version || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}<br>`;
    result += `–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${Telegram.WebApp.platform || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}<br>`;
    result += `–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞: ${Telegram.WebApp.colorScheme || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}<br>`;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    if (typeof Telegram.WebApp.sendData === 'function') {
      result += '‚úÖ –ú–µ—Ç–æ–¥ sendData –¥–æ—Å—Ç—É–ø–µ–Ω<br>';
    } else {
      result += '‚ùå –ú–µ—Ç–æ–¥ sendData –ù–ï –¥–æ—Å—Ç—É–ø–µ–Ω<br>';
    }
    
    if (Telegram.WebApp.initDataUnsafe) {
      result += '‚úÖ initDataUnsafe –¥–æ—Å—Ç—É–ø–µ–Ω<br>';
    } else {
      result += '‚ùå initDataUnsafe –ù–ï –¥–æ—Å—Ç—É–ø–µ–Ω<br>';
    }
    
    type = 'success';
  } else {
    result = '<strong>‚ùå Telegram.WebApp –ù–ï –¥–æ—Å—Ç—É–ø–µ–Ω</strong><br>';
    result += '–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –ù–ï —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞<br>';
    result += '–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:<br>';
    result += '‚Ä¢ –ü—Ä—è–º–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ<br>';
    result += '‚Ä¢ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–æ–º–µ–Ω –≤ BotFather<br>';
    result += '‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–Ω–æ–ø–∫–æ–π –º–µ–Ω—é';
    type = 'error';
  }
  
  showResult('api-test', result, type);
}

// 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ initData
function checkInitData() {
  clearContainer('initdata-test');
  
  let result = '';
  let type = 'error';
  
  if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) {
    const initData = Telegram.WebApp.initData;
    result += '<strong>‚úÖ initData –Ω–∞–π–¥–µ–Ω</strong><br>';
    result += `–î–ª–∏–Ω–∞: ${initData.length} —Å–∏–º–≤–æ–ª–æ–≤<br>`;
    result += `–ü–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤: ${initData.substring(0, 100)}...<br>`;
    
    // –ü–∞—Ä—Å–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    const params = {};
    initData.split('&').forEach(param => {
      const [key, value] = param.split('=');
      if (key && value) {
        params[decodeURIComponent(key)] = decodeURIComponent(value);
      }
    });
    
    result += '<br><strong>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</strong><br>';
    result += `<pre>${JSON.stringify(params, null, 2)}</pre>`;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    if (params.auth_date && params.user && params.hash) {
      type = 'success';
      result += '<br><strong>‚úÖ –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç</strong>';
    } else {
      type = 'warning';
      result += '<br><strong>‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</strong>';
    }
    
  } else {
    result = '<strong>‚ùå initData –ù–ï –Ω–∞–π–¥–µ–Ω</strong><br>';
    result += '–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é, –Ω–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞';
    type = 'error';
  }
  
  showResult('initdata-test', result, type);
}

// –û—á–∏—Å—Ç–∫–∞ initData –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ –ø—Ä—è–º–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è
function clearInitData() {
  if (window.Telegram && Telegram.WebApp) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
    if (!window.originalInitData) {
      window.originalInitData = Telegram.WebApp.initData;
    }
    // "–û—á–∏—â–∞–µ–º"
    Telegram.WebApp.initData = '';
    showResult('initdata-test', 'initData –æ—á–∏—â–µ–Ω (—Å–∏–º—É–ª—è—Ü–∏—è –ø—Ä—è–º–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è). –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å API" –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞.', 'warning');
  }
}

// 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function checkUserData() {
  clearContainer('user-test');
  
  let result = '';
  let type = 'error';
  
  if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe) {
    const user = Telegram.WebApp.initDataUnsafe.user;
    
    if (user) {
      result += '<strong>‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–π–¥–µ–Ω—ã</strong><br>';
      result += `<pre>${JSON.stringify(user, null, 2)}</pre>`;
      type = 'success';
    } else {
      result = '<strong>‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ù–ï –Ω–∞–π–¥–µ–Ω—ã</strong><br>';
      result += 'initDataUnsafe.user —Ä–∞–≤–µ–Ω null –∏–ª–∏ undefined';
      type = 'error';
    }
  } else {
    result = '<strong>‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</strong><br>';
    result += 'Telegram.WebApp.initDataUnsafe –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
    type = 'error';
  }
  
  showResult('user-test', result, type);
}

// 4. –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
function testSendData() {
  clearContainer('send-test');
  
  let result = '';
  let type = 'error';
  
  if (window.Telegram && Telegram.WebApp && typeof Telegram.WebApp.sendData === 'function') {
    try {
      const testData = {
        type: 'test',
        timestamp: new Date().toISOString(),
        message: '–¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏'
      };
      
      Telegram.WebApp.sendData(JSON.stringify(testData));
      
      result = '<strong>‚úÖ sendData –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ</strong><br>';
      result += '–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è.<br>';
      result += `–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ: <pre>${JSON.stringify(testData, null, 2)}</pre>`;
      type = 'success';
      
    } catch (error) {
      result = `<strong>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ${error.message}</strong>`;
      type = 'error';
    }
  } else {
    result = '<strong>‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</strong><br>';
    result += 'Telegram.WebApp.sendData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
    type = 'error';
  }
  
  showResult('send-test', result, type);
}

// –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –≤–Ω–µ—à–Ω–∏–π webhook
function testSendToWebhook() {
  clearContainer('send-test');
  
  let result = '';
  let type = 'warning';
  
  // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å URL –≤–∞—à–µ–≥–æ webhook –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  const webhookUrl = prompt('–í–≤–µ–¥–∏—Ç–µ URL –≤–∞—à–µ–≥–æ webhook (–Ω–∞–ø—Ä–∏–º–µ—Ä, URL n8n –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞):', '');
  
  if (!webhookUrl) {
    showResult('send-test', 'URL webhook –Ω–µ —É–∫–∞–∑–∞–Ω', 'error');
    return;
  }
  
  const testData = {
    type: 'webhook_test',
    timestamp: new Date().toISOString(),
    initData: Telegram.WebApp ? Telegram.WebApp.initData : null,
    userData: Telegram.WebApp && Telegram.WebApp.initDataUnsafe ? Telegram.WebApp.initDataUnsafe : null,
    message: '–¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ webhook'
  };
  
  fetch(webhookUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(testData)
  })
  .then(response => response.json())
  .then(data => {
    result = '<strong>‚úÖ –ó–∞–ø—Ä–æ—Å –≤ webhook –≤—ã–ø–æ–ª–Ω–µ–Ω</strong><br>';
    result += `–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}<br>`;
    result += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    showResult('send-test', result, 'success');
  })
  .catch(error => {
    result = `<strong>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ webhook: ${error.message}</strong>`;
    showResult('send-test', result, 'error');
  });
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', function() {
  // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp
  setTimeout(checkTelegramAPI, 100);
  setTimeout(checkInitData, 200);
  setTimeout(checkUserData, 300);
});
</script>

</body>
</html>